<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Free Medical Services & Checkup for International Students</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: #f8fafc;
      color: #1a202c;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      max-width: 480px;
      width: 100%;
      background: #ffffff;
      border-radius: 24px;
      padding: 48px 40px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      animation: slideUp 0.6s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    h1 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #1a202c;
      letter-spacing: -0.5px;
      line-height: 1.4;
    }

    .subtitle {
      font-size: 14px;
      color: #718096;
      font-weight: 400;
    }

    .form-group {
      margin-bottom: 24px;
      position: relative;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #2d3748;
      transition: color 0.2s ease;
    }

    input,
    textarea,
    select {
      width: 100%;
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      color: #1a202c;
      padding: 14px 16px;
      font-family: inherit;
      font-size: 15px;
      transition: all 0.3s ease;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      background: #ffffff;
      border-color: #6366f1;
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
      transform: translateY(-1px);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }

    .age-display {
      margin-top: 8px;
      font-size: 13px;
      color: #667eea;
      font-weight: 600;
      opacity: 0;
      transform: translateY(-5px);
      transition: all 0.3s ease;
    }

    .age-display.show {
      opacity: 1;
      transform: translateY(0);
    }

    button[type="submit"] {
      width: 100%;
      background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
      color: #ffffff;
      border: none;
      border-radius: 12px;
      padding: 16px;
      font-family: inherit;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
      margin-top: 8px;
    }

    button[type="submit"]:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 15px 35px rgba(99, 102, 241, 0.4);
    }

    button[type="submit"]:active:not(:disabled) {
      transform: translateY(0);
    }

    button[type="submit"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .error {
      color: #e53e3e;
      font-size: 13px;
      font-weight: 500;
      margin-top: 12px;
      padding: 12px 16px;
      background: #fff5f5;
      border-radius: 8px;
      border-left: 4px solid #e53e3e;
      display: none;
      animation: shake 0.4s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .error.show {
      display: block;
    }

    .success-message {
      position: fixed;
      inset: 0;
      background: #ffffff;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      gap: 24px;
      text-align: center;
      padding: 20px;
      z-index: 1000;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .success-message.show {
      display: flex;
    }

    .token-card {
      background: #ffffff;
      border-radius: 24px;
      padding: 48px 64px;
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.3);
      animation: scaleIn 0.5s ease 0.2s both;
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .token-label {
      font-size: 14px;
      font-weight: 600;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 16px;
    }

    .token-display {
      font-size: 72px;
      font-weight: 900;
      letter-spacing: 8px;
      color: #667eea;
      font-family: 'Courier New', monospace;
    }

    .success-text {
      font-size: 24px;
      font-weight: 700;
      color: #1a202c;
      letter-spacing: 0.5px;
      animation: slideUp 0.5s ease 0.4s both;
    }

    .success-text.subtext {
      font-size: 16px;
      font-weight: 400;
      color: #64748b;
      animation: slideUp 0.5s ease 0.6s both;
    }

    .required {
      color: #e53e3e;
    }

    @media (max-width: 600px) {
      .container {
        padding: 36px 28px;
        border-radius: 20px;
      }

      h1 {
        font-size: 22px;
      }

      .token-card {
        padding: 36px 48px;
      }

      .token-display {
        font-size: 56px;
        letter-spacing: 6px;
      }

      .success-text {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Free Medical Services & Checkup for International Students</h1>
      <p class="subtitle">please provide your details below.</p>
    </div>

    <form id="checkinForm">
      <div class="form-group">
        <label for="name">Full Name <span class="required">*</span></label>
        <input type="text" id="name" name="name" required autocomplete="name">
      </div>

      <div class="form-group">
        <label for="birthday">Date of Birth <span class="required">*</span></label>
        <input
          type="text"
          id="birthday"
          name="birthday"
          required
          autocomplete="bday"
          inputmode="numeric"
          placeholder="YYYY-MM-DD"
        >
        <div class="age-display" id="ageDisplay"></div>
      </div>

      <div class="form-group">
        <label for="country">Country <span class="required">*</span></label>
        <input
          type="text"
          id="country"
          name="country"
          list="countryList"
          autocomplete="off"
          required
          placeholder="Start typing your country"
        >
        <datalist id="countryList"></datalist>
      </div>

      <div class="form-group">
        <label for="phone">Phone Number <span class="required">*</span></label>
        <input
          type="tel"
          id="phone"
          name="phone"
          required
          autocomplete="tel"
          placeholder="+1 234 567 8900"
        >
      </div>

      <div class="form-group">
        <label for="sex">Sex <span class="required">*</span></label>
        <select id="sex" name="sex" required>
          <option value="">Select an option</option>
          <option value="Female">Female</option>
          <option value="Male">Male</option>
          <option value="Other">Other</option>
          <option value="Prefer not to say">Prefer not to say</option>
        </select>
      </div>

      <div class="form-group">
        <label for="details">Reason for Visit / Symptoms</label>
        <textarea
          id="details"
          name="details"
          placeholder="Briefly describe your symptoms or reason for visit (optional)"
        ></textarea>
      </div>

      <button type="submit" id="submitBtn">Check In Now</button>
      <div class="error" id="errorMsg"></div>
    </form>
  </div>

  <div class="success-message" id="successMessage">
    <div class="token-card">
      <div class="token-label">Your Token Number</div>
      <div class="token-display" id="tokenDisplay">---</div>
    </div>
    <div class="success-text">Check-in Successful!</div>
    <div class="success-text subtext">Please wait in the waiting room</div>
    <div class="success-text subtext" style="font-size: 15px;">
      Please take a screenshot of your token.
    </div>
  </div>

  <script>
    const API_URL = window.location.origin;

    const countries = [
      'Afghanistan', 'Albania', 'Algeria', 'Andorra', 'Angola', 'Antigua and Barbuda',
      'Argentina', 'Armenia', 'Australia', 'Austria', 'Azerbaijan', 'Bahamas', 'Bahrain',
      'Bangladesh', 'Barbados', 'Belarus', 'Belgium', 'Belize', 'Benin', 'Bhutan', 'Bolivia',
      'Bosnia and Herzegovina', 'Botswana', 'Brazil', 'Brunei', 'Bulgaria', 'Burkina Faso',
      'Burundi', 'Cabo Verde', 'Cambodia', 'Cameroon', 'Canada', 'Central African Republic',
      'Chad', 'Chile', 'China', 'Colombia', 'Comoros', 'Congo', 'Cote d Ivoire', 'Costa Rica', 'Croatia',
      'Cuba', 'Cyprus', 'Czech Republic', 'Democratic Republic of the Congo', 'Denmark',
      'Djibouti', 'Dominica', 'Dominican Republic', 'Ecuador', 'Egypt', 'El Salvador',
      'Equatorial Guinea', 'Eritrea', 'Estonia', 'Eswatini', 'Ethiopia', 'Fiji', 'Finland',
      'France', 'Gabon', 'Gambia', 'Georgia', 'Germany', 'Ghana', 'Greece', 'Grenada',
      'Guatemala', 'Guinea', 'Guinea-Bissau', 'Guyana', 'Haiti', 'Honduras', 'Hong Kong', 'Hungary',
      'Iceland', 'India', 'Indonesia', 'Iran', 'Iraq', 'Ireland', 'Israel', 'Italy', 'Jamaica',
      'Japan', 'Jordan', 'Kazakhstan', 'Kenya', 'Kiribati', 'Kosovo', 'Kuwait', 'Kyrgyzstan', 'Laos',
      'Latvia', 'Lebanon', 'Lesotho', 'Liberia', 'Libya', 'Liechtenstein', 'Lithuania',
      'Luxembourg', 'Macau', 'Madagascar', 'Malawi', 'Malaysia', 'Maldives', 'Mali', 'Malta',
      'Marshall Islands', 'Mauritania', 'Mauritius', 'Mexico', 'Micronesia', 'Moldova',
      'Monaco', 'Mongolia', 'Montenegro', 'Morocco', 'Mozambique', 'Myanmar', 'Namibia',
      'Nauru', 'Nepal', 'Netherlands', 'New Zealand', 'Nicaragua', 'Niger', 'Nigeria',
      'North Korea', 'North Macedonia', 'Norway', 'Oman', 'Pakistan', 'Palau', 'Palestine', 'Panama',
      'Papua New Guinea', 'Paraguay', 'Peru', 'Philippines', 'Poland', 'Portugal', 'Qatar',
      'Romania', 'Russia', 'Rwanda', 'Saint Kitts and Nevis', 'Saint Lucia',
      'Saint Vincent and the Grenadines', 'Samoa', 'San Marino', 'Sao Tome and Principe',
      'Saudi Arabia', 'Senegal', 'Serbia', 'Seychelles', 'Sierra Leone', 'Singapore',
      'Slovakia', 'Slovenia', 'Solomon Islands', 'Somalia', 'South Africa', 'South Korea',
      'South Sudan', 'Spain', 'Sri Lanka', 'Sudan', 'Suriname', 'Sweden', 'Switzerland',
      'Syria', 'Taiwan', 'Tajikistan', 'Tanzania', 'Thailand', 'Timor-Leste', 'Togo',
      'Tonga', 'Trinidad and Tobago', 'Tunisia', 'Turkey', 'Turkmenistan', 'Tuvalu', 'Uganda',
      'Ukraine', 'United Arab Emirates', 'United Kingdom', 'United States', 'Uruguay',
      'Uzbekistan', 'Vanuatu', 'Vatican City', 'Venezuela', 'Vietnam', 'Western Sahara', 'Yemen', 'Zambia',
      'Zimbabwe'
    ];

    const form = document.getElementById('checkinForm');
    const birthdayInput = document.getElementById('birthday');
    const ageDisplay = document.getElementById('ageDisplay');
    const countryInput = document.getElementById('country');
    const submitBtn = document.getElementById('submitBtn');
    const errorMsg = document.getElementById('errorMsg');
    const successMessage = document.getElementById('successMessage');
    const tokenDisplay = document.getElementById('tokenDisplay');
    const detailsInput = document.getElementById('details');
    const countryListEl = document.getElementById('countryList');
    const phoneInput = document.getElementById('phone');
    const sexSelect = document.getElementById('sex');
    const nameInput = document.getElementById('name');

    countries.forEach((country) => {
      const option = document.createElement('option');
      option.value = country;
      countryListEl.appendChild(option);
    });

    function formatIsoDate(year, month, day) {
      const yyyy = String(year).padStart(4, '0');
      const mm = String(month).padStart(2, '0');
      const dd = String(day).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function parseDateInput(value) {
      const trimmed = (value || '').trim();
      if (!trimmed) {
        return null;
      }

      const isoMatch = trimmed.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
      if (isoMatch) {
        const year = Number(isoMatch[1]);
        const month = Number(isoMatch[2]) - 1;
        const day = Number(isoMatch[3]);
        const candidate = new Date(year, month, day);
        if (
          candidate.getFullYear() === year &&
          candidate.getMonth() === month &&
          candidate.getDate() === day
        ) {
          return candidate;
        }
        return null;
      }

      const digitsMatch = trimmed.match(/^(\d{4})(\d{2})(\d{2})$/);
      if (digitsMatch) {
        const year = Number(digitsMatch[1]);
        const month = Number(digitsMatch[2]) - 1;
        const day = Number(digitsMatch[3]);
        const candidate = new Date(year, month, day);
        if (
          candidate.getFullYear() === year &&
          candidate.getMonth() === month &&
          candidate.getDate() === day
        ) {
          return candidate;
        }
        return null;
      }

      const parsed = new Date(trimmed);
      if (Number.isNaN(parsed.getTime())) {
        return null;
      }
      return parsed;
    }

    function calculateAge(dateValue) {
      const birthday = parseDateInput(dateValue);
      if (!birthday) {
        return null;
      }
      const today = new Date();
      let age = today.getFullYear() - birthday.getFullYear();
      const monthDiff = today.getMonth() - birthday.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthday.getDate())) {
        age--;
      }
      return age;
    }

    function updateAgePreview(value) {
      const trimmed = (value || '').trim();
      let normalizedValue = trimmed;

      const digitsMatch = trimmed.match(/^(\d{4})(\d{2})(\d{2})$/);
      if (digitsMatch) {
        const year = Number(digitsMatch[1]);
        const month = Number(digitsMatch[2]);
        const day = Number(digitsMatch[3]);
        const candidate = parseDateInput(trimmed);
        if (candidate) {
          const formatted = formatIsoDate(year, month, day);
          normalizedValue = formatted;
          if (birthdayInput.value !== formatted) {
            birthdayInput.value = formatted;
          }
        }
      }

      const age = calculateAge(normalizedValue);
      if (!trimmed) {
        ageDisplay.textContent = '';
        ageDisplay.classList.remove('show');
        return;
      }

      ageDisplay.classList.add('show');
      if (age !== null && age >= 0 && age < 150) {
        ageDisplay.textContent = `Age: ${age} years old`;
        ageDisplay.style.color = '#667eea';
      } else {
        ageDisplay.textContent = 'Invalid date';
        ageDisplay.style.color = '#e53e3e';
      }
    }

    birthdayInput.addEventListener('input', (event) => {
      updateAgePreview(event.target.value);
    });

    function normalizeCountry(value) {
      const trimmed = value.trim();
      if (!trimmed) {
        return '';
      }
      if (trimmed.length <= 3 && /^[a-zA-Z]+$/.test(trimmed)) {
        return trimmed.toUpperCase();
      }
      return trimmed
        .split(/\s+/)
        .map(part => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase())
        .join(' ');
    }

    function isValidPhoneNumber(value) {
      const digits = value.replace(/\D/g, '');
      return digits.length >= 7 && digits.length <= 15;
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      submitBtn.disabled = true;
      submitBtn.textContent = 'Checking In...';
      errorMsg.classList.remove('show');

      const birthdayRaw = birthdayInput.value;
      updateAgePreview(birthdayRaw);
      const normalizedBirthday = birthdayInput.value.trim();
      const age = calculateAge(normalizedBirthday);
      if (age === null || age < 0 || age >= 150) {
        errorMsg.textContent = 'Please enter a valid birth date.';
        errorMsg.classList.add('show');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Check In Now';
        return;
      }

      const normalizedCountry = normalizeCountry(countryInput.value);
      countryInput.value = normalizedCountry;

      if (!normalizedCountry) {
        errorMsg.textContent = 'Please choose your country.';
        errorMsg.classList.add('show');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Check In Now';
        return;
      }

      const phoneValue = phoneInput.value.trim();
      if (!phoneValue) {
        errorMsg.textContent = 'Please enter your phone number.';
        errorMsg.classList.add('show');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Check In Now';
        return;
      }

      if (!isValidPhoneNumber(phoneValue)) {
        errorMsg.textContent = 'Please enter a valid phone number.';
        errorMsg.classList.add('show');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Check In Now';
        return;
      }

      const sexValue = sexSelect.value;
      if (!sexValue) {
        errorMsg.textContent = 'Please select your sex.';
        errorMsg.classList.add('show');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Check In Now';
        return;
      }

      const payload = {
        name: nameInput.value.trim(),
        age,
        country: normalizedCountry,
        details: detailsInput.value.trim(),
        phone: phoneValue,
        sex: sexValue,
      };

      try {
        const response = await fetch(`${API_URL}/api/checkin`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const data = await response.json();

        if (response.ok && data.success) {
          tokenDisplay.textContent = data.token || '---';
          successMessage.classList.add('show');
        } else {
          throw new Error(data.error || 'Check-in failed');
        }
      } catch (error) {
        console.error('Check-in error:', error);
        errorMsg.textContent = 'Check-in failed. Please try again.';
        errorMsg.classList.add('show');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Check In Now';
      }
    });
  </script>
</body>
</html>
