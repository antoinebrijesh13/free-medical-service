<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff Console</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      color-scheme: light;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: #f8fafc;
      color: #1f2933;
      min-height: 100vh;
      padding: 40px 20px 80px;
      display: flex;
      justify-content: center;
    }

    .console {
      width: 100%;
      max-width: 1100px;
      border: 1px solid #e2e8f0;
      background: #ffffff;
      padding: 40px;
      display: flex;
      flex-direction: column;
      gap: 30px;
      border-radius: 24px;
      box-shadow: 0 24px 64px -35px rgba(15, 23, 42, 0.35);
    }

    .console__header {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    h1 {
      font-size: 26px;
      font-weight: normal;
      letter-spacing: 4px;
      text-transform: uppercase;
      text-align: center;
      padding-bottom: 20px;
      border-bottom: 1px solid #d9e2ec;
      color: #102a43;
    }

    .summary {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }

    .summary__item {
      border: 1px solid #e2e8f0;
      padding: 16px 24px;
      text-align: center;
      min-width: 140px;
      letter-spacing: 2px;
      background: #f8fafc;
      border-radius: 16px;
    }

    .summary__label {
      font-size: 11px;
      text-transform: uppercase;
      color: #7b8794;
      margin-bottom: 8px;
      display: block;
    }

    .summary__value {
      font-size: 24px;
      color: #1f2933;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      justify-content: center;
      border: 1px solid #e2e8f0;
      padding: 24px;
      background: #f8fafc;
      border-radius: 18px;
    }

    .actions label {
      font-size: 12px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #7b8794;
    }

    input[type="number"] {
      background: #ffffff;
      border: 1px solid #cbd2d9;
      color: #1f2933;
      font-size: 16px;
      padding: 10px 14px;
      width: 140px;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="number"]:focus {
      outline: none;
      border-color: #2d6cdf;
      box-shadow: 0 0 0 3px rgba(45, 108, 223, 0.15);
    }

    button {
      appearance: none;
      background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
      color: #ffffff;
      border: none;
      font-size: 14px;
      letter-spacing: 2px;
      text-transform: uppercase;
      padding: 12px 24px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      min-width: 160px;
      border-radius: 14px;
      box-shadow: 0 12px 30px -16px rgba(99, 102, 241, 0.45);
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 16px 28px -18px rgba(45, 108, 223, 0.7);
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      box-shadow: none;
    }

    .table-wrapper {
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 700px;
      background: #ffffff;
      border-radius: 18px;
    }

    thead th {
      font-weight: normal;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-size: 12px;
      text-align: left;
      padding: 16px 20px;
      border-bottom: 1px solid #edf2f7;
      color: #334e68;
      background: #e4ebf5;
    }

    tbody td {
      padding: 14px 20px;
      border-bottom: 1px solid #edf2f7;
      vertical-align: middle;
      color: #1f2933;
      background: #ffffff;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .status {
      padding: 6px 12px;
      border: 1px solid #cbd2d9;
      display: inline-block;
      letter-spacing: 2px;
      font-size: 11px;
      text-transform: uppercase;
      color: #334e68;
      background: #f5f7fa;
      border-radius: 999px;
    }

    .status--allowed {
      background: #3ecf8e;
      color: #0f172a;
      border-color: #3ecf8e;
    }

    .status--waiting {
      background: #f5f7fa;
      color: #334e68;
    }

    .actions-cell {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .actions-cell button {
      padding: 10px 18px;
      min-width: auto;
      background: #ffffff;
      color: #1f2933;
      border: 1px solid #d1d5db;
      box-shadow: none;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      border-radius: 12px;
    }

    .actions-cell button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px -18px rgba(16, 42, 67, 0.35);
    }

    .actions-cell button.remove {
      background: #ffffff;
      color: #d64545;
      border: 1px solid #fca5a5;
    }

    .actions-cell button.remove:hover:not(:disabled) {
      background: #d64545;
      color: #ffffff;
      box-shadow: 0 12px 24px -18px rgba(214, 69, 69, 0.4);
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      letter-spacing: 2px;
      color: #7b8794;
    }

    @media (max-width: 768px) {
      body {
        padding: 20px 10px 60px;
      }

      .console {
        padding: 30px 20px;
      }

      table {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="console">
    <div class="console__header">
      <h1>Staff Console</h1>

      <div class="summary" id="summary">
        <div class="summary__item">
          <span class="summary__label">Total Patients</span>
          <span class="summary__value" id="totalCount">0</span>
        </div>
        <div class="summary__item">
          <span class="summary__label">Waiting</span>
          <span class="summary__value" id="waitingCount">0</span>
        </div>
        <div class="summary__item">
          <span class="summary__label">Admitted</span>
          <span class="summary__value" id="allowedCount">0</span>
        </div>
      </div>

      <div class="actions">
        <label for="bulkCount">Admit Next</label>
        <input type="number" id="bulkCount" min="1" value="5">
        <button id="bulkAdmitBtn">Execute</button>
        <button id="refreshBtn">Refresh</button>
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th style="width: 110px;">Token</th>
            <th style="width: 220px;">Name</th>
            <th>Details</th>
            <th style="width: 140px;">Status</th>
            <th style="width: 240px;">Actions</th>
          </tr>
        </thead>
        <tbody id="patientsBody">
          <tr class="empty-state">
            <td colspan="5">Awaiting first patient...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    const patientsBody = document.getElementById('patientsBody');
    const bulkInput = document.getElementById('bulkCount');
    const bulkBtn = document.getElementById('bulkAdmitBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const totalCountEl = document.getElementById('totalCount');
    const waitingCountEl = document.getElementById('waitingCount');
    const allowedCountEl = document.getElementById('allowedCount');

    const socket = io();
    let patients = [];
    let loading = false;

    function escapeHtml(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function setLoading(state) {
      loading = state;
      bulkBtn.disabled = state;
      refreshBtn.disabled = state;
      const actionButtons = patientsBody.querySelectorAll('button');
      actionButtons.forEach(btn => {
        if (btn.dataset.lockable === 'true') {
          btn.disabled = state;
        }
      });
    }

    function upsertPatient(patient) {
      const existingIndex = patients.findIndex(p => p.token === patient.token);
      if (existingIndex >= 0) {
        patients[existingIndex] = { ...patients[existingIndex], ...patient };
      } else {
        patients.push(patient);
      }
    }

    function removePatient(token) {
      patients = patients.filter(p => p.token !== token);
    }

    function comparePatients(a, b) {
      return a.id - b.id;
    }

    function getStatusClass(status) {
      return status === 'allowed' ? 'status status--allowed' : 'status status--waiting';
    }

    function renderTable() {
      patients.sort(comparePatients);

      const waitingCount = patients.filter(p => p.status === 'waiting').length;
      const allowedCount = patients.filter(p => p.status === 'allowed').length;

      totalCountEl.textContent = patients.length;
      waitingCountEl.textContent = waitingCount;
      allowedCountEl.textContent = allowedCount;

      if (!patients.length) {
        patientsBody.innerHTML = `
          <tr class="empty-state">
            <td colspan="5">Queue is currently empty.</td>
          </tr>
        `;
        return;
      }

      patientsBody.innerHTML = patients.map(patient => {
        const { token, name, status, details, country, age, sex, phone } = patient;
        const canAdmit = status === 'waiting';
        const displayDetails = details
          ? escapeHtml(details).replace(/\r?\n/g, '<br>')
          : '—';
        const displayCountry = country ? escapeHtml(country) : 'Unknown';
        const displayAge = Number.isFinite(age) ? `${age}` : '?';
        const displaySex = sex ? escapeHtml(sex) : '—';
        const displayPhone = phone ? escapeHtml(phone) : '—';

        return `
          <tr>
            <td>${escapeHtml(token)}</td>
            <td>
              <div>${escapeHtml(name)}</div>
              <div style="font-size: 12px; color: #7b8794; letter-spacing: 1px; margin-top: 6px;">
                ${displayCountry} · ${displayAge} yrs
              </div>
              <div style="font-size: 12px; color: #7b8794; letter-spacing: 1px; margin-top: 4px;">
                Sex: ${displaySex}
              </div>
              <div style="font-size: 12px; color: #7b8794; letter-spacing: 1px; margin-top: 4px;">
                Phone: ${displayPhone}
              </div>
            </td>
            <td style="font-size: 13px; line-height: 1.5;">
              ${displayDetails}
            </td>
            <td>
              <span class="${getStatusClass(status)}">${status}</span>
            </td>
            <td class="actions-cell">
              <button
                class="admit"
                data-token="${token}"
                data-action="admit"
                data-lockable="true"
                ${canAdmit ? '' : 'disabled'}
              >
                Admit
              </button>
              <button
                class="remove"
                data-token="${token}"
                data-action="remove"
                data-lockable="true"
              >
                Remove
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function handleSocketEvents() {
      socket.on('new-patient', (patient) => {
        upsertPatient(patient);
        renderTable();
      });

      socket.on('allowed-update', (allowedList) => {
        const allowedTokens = new Set((allowedList || []).map(p => p.token));
        allowedList.forEach(p => upsertPatient(p));

        patients = patients.map(patient => {
          if (allowedTokens.has(patient.token)) {
            return { ...patient, status: 'allowed' };
          }
          if (patient.status === 'allowed') {
            return { ...patient, status: 'waiting' };
          }
          return patient;
        });

        renderTable();
      });

      socket.on('patient-finished', (token) => {
        removePatient(token);
        renderTable();
      });
    }

    async function fetchPatients() {
      setLoading(true);
      try {
        const res = await fetch(`${API_BASE}/api/patients`);
        if (!res.ok) throw new Error('Failed to fetch patients');
        const data = await res.json();
        patients = data;
        renderTable();
      } catch (error) {
        console.error(error);
      } finally {
        setLoading(false);
      }
    }

    async function admitPatient(token) {
      setLoading(true);
      try {
        const res = await fetch(`${API_BASE}/api/admit/${token}`, { method: 'POST' });
        if (!res.ok) throw new Error('Failed to admit patient');
      } catch (error) {
        console.error(error);
      } finally {
        setLoading(false);
      }
    }

    async function removePatientRequest(token) {
      setLoading(true);
      try {
        const res = await fetch(`${API_BASE}/api/remove/${token}`, { method: 'POST' });
        if (!res.ok) throw new Error('Failed to remove patient');
      } catch (error) {
        console.error(error);
      } finally {
        setLoading(false);
      }
    }

    async function admitNextBatch() {
      const value = parseInt(bulkInput.value, 10);
      if (!Number.isFinite(value) || value <= 0) {
        bulkInput.focus();
        return;
      }

      setLoading(true);
      try {
        const res = await fetch(`${API_BASE}/api/next`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ count: value }),
        });
        if (!res.ok) throw new Error('Failed to admit next patients');
      } catch (error) {
        console.error(error);
      } finally {
        setLoading(false);
      }
    }

    patientsBody.addEventListener('click', (event) => {
      const button = event.target.closest('button[data-action]');
      if (!button || button.disabled || loading) return;

      const { action, token } = button.dataset;

      if (action === 'admit') {
        admitPatient(token);
      }

      if (action === 'remove') {
        removePatientRequest(token);
      }
    });

    bulkBtn.addEventListener('click', () => {
      if (!loading) {
        admitNextBatch();
      }
    });

    refreshBtn.addEventListener('click', () => {
      if (!loading) {
        fetchPatients();
      }
    });

    handleSocketEvents();
    fetchPatients();
  </script>
</body>
</html>
