<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clinic Display Board</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      color-scheme: light;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: #f4f7fb;
      color: #1f2933;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px 60px;
    }

    .board {
      width: 100%;
      max-width: 1320px;
      border: 1px solid #e2e8f0;
      padding: 50px 60px 60px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 30px;
      border-radius: 28px;
      box-shadow: 0 35px 70px -40px rgba(15, 23, 42, 0.45);
    }

    h1 {
      font-size: 36px;
      font-weight: normal;
      letter-spacing: 10px;
      text-transform: uppercase;
      text-align: center;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 24px;
      color: #102a43;
    }

    .ticker {
      font-size: 18px;
      text-align: center;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: #627d98;
    }

    .legend {
      display: flex;
      justify-content: center;
      gap: 30px;
      font-size: 12px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #7b8794;
    }

    .legend span {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend .badge {
      width: 16px;
      height: 16px;
      border: 2px solid #cbd2d9;
      background: #f8fafc;
      border-radius: 6px;
    }

    .legend .badge--allowed {
      background: #3ecf8e;
      border-color: #3ecf8e;
    }

    .stats {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 24px;
    }

    .stats__item {
      border: 1px solid #e2e8f0;
      padding: 18px 28px;
      text-align: center;
      letter-spacing: 3px;
      text-transform: uppercase;
      min-width: 200px;
      background: #f8fafc;
      border-radius: 18px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }

    .stats__label {
      display: block;
      font-size: 12px;
      color: #7b8794;
      margin-bottom: 10px;
    }

    .stats__value {
      font-size: 26px;
      color: #1f2933;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 26px;
    }

    .card {
      border: 1px solid #e2e8f0;
      padding: 30px 24px;
      text-align: center;
      letter-spacing: 2px;
      opacity: 0;
      transform: translateY(16px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      min-height: 170px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #ffffff;
      border-radius: 22px;
      box-shadow: 0 24px 60px -38px rgba(15, 23, 42, 0.4);
    }

    .card--visible {
      opacity: 1;
      transform: translateY(0);
    }

    .card__token {
      font-size: 40px;
      letter-spacing: 10px;
      color: #102a43;
    }

    .card__name {
      font-size: 20px;
      text-transform: uppercase;
      line-height: 1.4;
      color: #243b53;
    }

    .card__meta {
      display: flex;
      justify-content: center;
      gap: 16px;
      font-size: 13px;
      letter-spacing: 2px;
      color: #7b8794;
      text-transform: uppercase;
    }

    .card__details {
      font-size: 12px;
      color: #829ab1;
      text-transform: uppercase;
    }

    .card__status {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 8px 16px;
      font-size: 12px;
      letter-spacing: 3px;
      text-transform: uppercase;
      border: 1px solid #cbd2d9;
      color: #334e68;
      background: #f5f7fa;
      border-radius: 999px;
    }

    .card__status--allowed {
      background: #3ecf8e;
      color: #0f172a;
      border-color: #3ecf8e;
    }

    .card__status--waiting {
      background: #eef2ff;
      border-color: #c7d2fe;
      color: #4c51bf;
    }

    .card--placeholder {
      background: #f8fafc;
      border-style: dashed;
      box-shadow: none;
    }

    .empty {
      text-align: center;
      padding: 60px 20px;
      letter-spacing: 6px;
      color: #7b8794;
      font-size: 20px;
    }

    .footer {
      font-size: 14px;
      letter-spacing: 3px;
      color: #7b8794;
      text-transform: uppercase;
      text-align: center;
      margin-top: 30px;
    }

    @media (max-width: 600px) {
      body {
        padding: 20px 10px 40px;
      }

      .board {
        padding: 30px 20px;
      }

      h1 {
        font-size: 28px;
      }

      .card__token {
        font-size: 32px;
      }
    }
  </style>
</head>
<body>
  <div class="board">
    <h1>Now Admitting</h1>
    <div class="ticker" id="ticker">Awaiting updates...</div>
    <div class="legend">
      <span><span class="badge badge--allowed"></span>Allowed</span>
      <span><span class="badge"></span>Available Slot</span>
    </div>
    <div class="stats">
      <div class="stats__item">
        <span class="stats__label">Total</span>
        <span class="stats__value" id="totalCount">0</span>
      </div>
      <div class="stats__item">
        <span class="stats__label">People Waiting</span>
        <span class="stats__value" id="waitingCount">0</span>
      </div>
      <div class="stats__item">
        <span class="stats__label">People Allowed</span>
        <span class="stats__value" id="allowedCount">0</span>
      </div>
    </div>
    <div class="grid" id="grid"></div>
    <div class="empty" id="emptyState">No people admitted yet. Please wait for your token.</div>
  </div>
  <p class="footer">This board updates in real time. Proceed when your token is displayed.</p>

  <script>
    const API_BASE = window.location.origin;
    const TOTAL_CARD_SLOTS = 20;
    const grid = document.getElementById('grid');
    const emptyState = document.getElementById('emptyState');
    const ticker = document.getElementById('ticker');
    const socket = io();

    let admitted = [];
    let snapshotCounts = { total: 0, waiting: 0, allowed: 0 };

    function formatTicker(count) {
      if (!count) {
        return 'Awaiting updates...';
      }
      return `${count} person${count === 1 ? '' : 's'} currently admitted`;
    }

    function renderCards() {
      const hasPeople = admitted.length > 0;
      emptyState.style.display = hasPeople ? 'none' : 'block';
      ticker.textContent = formatTicker(admitted.length);

      const cards = admitted
        .map((person) => {
          const age = Number.isFinite(person.age) ? `${person.age} yrs` : 'AGE N/A';
          const country = person.country || 'Unknown Origin';
          const statusText = (person.status || 'allowed').toUpperCase();
          const statusClass =
            statusText === 'ALLOWED' ? 'card__status card__status--allowed' : 'card__status';

          return `
            <div class="card card--visible" data-token="${person.token}">
              <div class="card__token">${person.token}</div>
              <div class="${statusClass}">${statusText}</div>
              <div class="card__name">${person.name}</div>
              <div class="card__meta">
                <span>${country}</span>
                <span>${age}</span>
              </div>
              <div class="card__details">Please proceed when called</div>
            </div>
          `;
        })
        .join('');

      const placeholdersCount = Math.max(0, TOTAL_CARD_SLOTS - admitted.length);
      const placeholders = Array.from({ length: placeholdersCount })
        .map(
          () => `
            <div class="card card--visible card--placeholder">
              <div class="card__token">---</div>
              <div class="card__status card__status--waiting">Waiting</div>
              <div class="card__name">Available Slot</div>
              <div class="card__details">Awaiting next person</div>
            </div>
          `
        )
        .join('');

      grid.innerHTML = cards + placeholders;

      document.getElementById('totalCount').textContent = snapshotCounts.total;
      document.getElementById('waitingCount').textContent = snapshotCounts.waiting;
      document.getElementById('allowedCount').textContent = snapshotCounts.allowed;
    }

    function setAdmitted(list) {
      admitted = (list || [])
        .slice(0, TOTAL_CARD_SLOTS)
        .map((person) => ({
          ...person,
          name: person.name || 'Unnamed',
          token: person.token || '---',
          status: (person.status || 'allowed').toUpperCase(),
        }));
      renderCards();
    }

    function removeToken(token) {
      const normalized = token.trim().toUpperCase();
      const next = admitted.filter((person) => person.token !== normalized);
      if (next.length !== admitted.length) {
        admitted = next;
        renderCards();
      }
    }

    async function fetchCounts() {
      try {
        const res = await fetch(`${API_BASE}/api/patients`);
        if (!res.ok) throw new Error('Failed to load people counts');
        const people = await res.json();

        snapshotCounts.total = Array.isArray(people) ? people.length : 0;
        snapshotCounts.waiting = Array.isArray(people)
          ? people.filter((p) => p.status === 'waiting').length
          : 0;
      } catch (error) {
        console.error(error);
        ticker.textContent = 'Unable to fetch data. Retrying...';
      }
    }

    async function fetchSnapshot() {
      try {
        const allowedRes = await fetch(`${API_BASE}/api/allowed`);
        if (!allowedRes.ok) throw new Error('Failed to load allowed people');

        const allowedData = await allowedRes.json();
        snapshotCounts.allowed = Array.isArray(allowedData) ? allowedData.length : 0;

        await fetchCounts();
        setAdmitted(allowedData);
      } catch (error) {
        console.error(error);
        ticker.textContent = 'Unable to fetch data. Retrying...';
      }
    }

    async function handleAllowedUpdate(list) {
      snapshotCounts.allowed = Array.isArray(list) ? list.length : 0;
      await fetchCounts();
      setAdmitted(list);
    }

    socket.on('allowed-update', (list) => {
      handleAllowedUpdate(list);
    });

    socket.on('patient-finished', async (token) => {
      removeToken(token);
      await fetchCounts();
      snapshotCounts.allowed = Math.min(admitted.length, TOTAL_CARD_SLOTS);
      renderCards();
    });

    socket.on('new-patient', async () => {
      await fetchCounts();
      renderCards();
    });

    fetchSnapshot();
  </script>
</body>
</html>
